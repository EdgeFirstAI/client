# Mobile SDK Build and Release Workflow
#
# This workflow builds the EdgeFirst Client FFI library for mobile platforms
# (Android and iOS/macOS) and generates Kotlin/Swift bindings using UniFFI.

name: Mobile SDK

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  # Pinned Rust version for CI/CD - update manually to control Rust upgrades
  # This ensures consistent builds and allows testing before upgrading
  RUST_STABLE_VERSION: "1.90"

jobs:
  # ============================================================================
  # Build Android Native Libraries
  # ============================================================================
  build-android:
    name: Build Android (${{ matrix.target }})
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        include:
          # ARM64 (most modern Android devices)
          - target: aarch64-linux-android
            abi: arm64-v8a
            ndk-arch: aarch64
          # ARM32 (older devices)
          - target: armv7-linux-androideabi
            abi: armeabi-v7a
            ndk-arch: arm
          # x86_64 (emulators and Chromebooks)
          - target: x86_64-linux-android
            abi: x86_64
            ndk-arch: x86_64

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@b3b07ba8b418998c39fb20f53e8b695cdcc8de1b # master
        with:
          toolchain: ${{ env.RUST_STABLE_VERSION }}
          targets: ${{ matrix.target }}

      - name: Cache Cargo
        uses: Swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6 # v2.7.8
        with:
          shared-key: android-${{ matrix.target }}
          cache-targets: true

      - name: Setup Android NDK
        uses: android-actions/setup-android@9fc6c4e9069bf8d3d10b2204b1fb8f6ef7065407 # v3.2.2
        with:
          packages: "ndk;27.2.12479018"

      - name: Configure NDK Environment
        run: |
          NDK_HOME="${ANDROID_HOME}/ndk/27.2.12479018"
          echo "NDK_HOME=${NDK_HOME}" >> $GITHUB_ENV
          echo "ANDROID_NDK_HOME=${NDK_HOME}" >> $GITHUB_ENV
          
          # Set up toolchain paths
          TOOLCHAIN="${NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64"
          echo "TOOLCHAIN=${TOOLCHAIN}" >> $GITHUB_ENV
          
          # Set compiler for this target
          case "${{ matrix.ndk-arch }}" in
            aarch64)
              echo "CC_aarch64_linux_android=${TOOLCHAIN}/bin/aarch64-linux-android24-clang" >> $GITHUB_ENV
              echo "AR_aarch64_linux_android=${TOOLCHAIN}/bin/llvm-ar" >> $GITHUB_ENV
              echo "CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER=${TOOLCHAIN}/bin/aarch64-linux-android24-clang" >> $GITHUB_ENV
              ;;
            arm)
              echo "CC_armv7_linux_androideabi=${TOOLCHAIN}/bin/armv7a-linux-androideabi24-clang" >> $GITHUB_ENV
              echo "AR_armv7_linux_androideabi=${TOOLCHAIN}/bin/llvm-ar" >> $GITHUB_ENV
              echo "CARGO_TARGET_ARMV7_LINUX_ANDROIDEABI_LINKER=${TOOLCHAIN}/bin/armv7a-linux-androideabi24-clang" >> $GITHUB_ENV
              ;;
            x86_64)
              echo "CC_x86_64_linux_android=${TOOLCHAIN}/bin/x86_64-linux-android24-clang" >> $GITHUB_ENV
              echo "AR_x86_64_linux_android=${TOOLCHAIN}/bin/llvm-ar" >> $GITHUB_ENV
              echo "CARGO_TARGET_X86_64_LINUX_ANDROID_LINKER=${TOOLCHAIN}/bin/x86_64-linux-android24-clang" >> $GITHUB_ENV
              ;;
          esac

      - name: Build FFI Library
        run: |
          cargo build --release --locked \
            -p edgefirst-client-ffi \
            --target ${{ matrix.target }}

      - name: Prepare Artifacts
        run: |
          mkdir -p artifacts/android/${{ matrix.abi }}
          cp target/${{ matrix.target }}/release/libedgefirst_client.so \
             artifacts/android/${{ matrix.abi }}/

      - name: Upload Artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: android-${{ matrix.abi }}
          path: artifacts/android/${{ matrix.abi }}/
          retention-days: 7

  # ============================================================================
  # Build Apple Native Libraries (iOS, iOS Simulator, macOS)
  # ============================================================================
  build-apple:
    name: Build Apple (${{ matrix.target }})
    runs-on: macos-14  # ARM64 runner for native iOS builds
    strategy:
      fail-fast: false
      matrix:
        include:
          # iOS Device (ARM64)
          - target: aarch64-apple-ios
            platform: ios
            arch: arm64
            deployment_target: IPHONEOS_DEPLOYMENT_TARGET=13.0
          # iOS Simulator (ARM64 - for M1/M2 Macs)
          - target: aarch64-apple-ios-sim
            platform: ios-sim-arm64
            arch: arm64
            deployment_target: IPHONEOS_DEPLOYMENT_TARGET=13.0
          # iOS Simulator (x86_64 - for Intel Macs)
          - target: x86_64-apple-ios
            platform: ios-sim-x86_64
            arch: x86_64
            deployment_target: IPHONEOS_DEPLOYMENT_TARGET=13.0
          # macOS (ARM64)
          - target: aarch64-apple-darwin
            platform: macos-arm64
            arch: arm64
            deployment_target: MACOSX_DEPLOYMENT_TARGET=10.15
          # macOS (x86_64)
          - target: x86_64-apple-darwin
            platform: macos-x86_64
            arch: x86_64
            deployment_target: MACOSX_DEPLOYMENT_TARGET=10.15

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@b3b07ba8b418998c39fb20f53e8b695cdcc8de1b # master
        with:
          toolchain: ${{ env.RUST_STABLE_VERSION }}
          targets: ${{ matrix.target }}

      - name: Cache Cargo
        uses: Swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6 # v2.7.8
        with:
          shared-key: apple-${{ matrix.target }}
          cache-targets: true

      - name: Build FFI Library
        run: |
          # Set deployment target to match Package.swift (iOS 13, macOS 10.15)
          ${{ matrix.deployment_target }} cargo build --release --locked \
            -p edgefirst-client-ffi \
            --target ${{ matrix.target }}

      - name: Prepare Artifacts
        run: |
          mkdir -p artifacts/apple/${{ matrix.platform }}
          cp target/${{ matrix.target }}/release/libedgefirst_client.a \
             artifacts/apple/${{ matrix.platform }}/
          # Also copy dylib for macOS if available
          if [ -f "target/${{ matrix.target }}/release/libedgefirst_client.dylib" ]; then
            cp target/${{ matrix.target }}/release/libedgefirst_client.dylib \
               artifacts/apple/${{ matrix.platform }}/
          fi

      - name: Upload Artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: apple-${{ matrix.platform }}
          path: artifacts/apple/${{ matrix.platform }}/
          retention-days: 7

  # ============================================================================
  # Generate Kotlin Bindings
  # ============================================================================
  generate-kotlin:
    name: Generate Kotlin Bindings
    runs-on: ubuntu-24.04
    needs: [build-android]

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@b3b07ba8b418998c39fb20f53e8b695cdcc8de1b # master
        with:
          toolchain: ${{ env.RUST_STABLE_VERSION }}

      # NOTE: Caching disabled for debugging - re-enable once binding generation is fixed
      # - name: Cache Cargo
      #   uses: Swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6 # v2.7.8
      #   with:
      #     shared-key: uniffi-bindgen
      #     cache-targets: true

      - name: Build uniffi-bindgen
        run: cargo build --release -p uniffi-bindgen

      - name: Build FFI Library (for UDL)
        run: cargo build --release -p edgefirst-client-ffi

      - name: Generate Kotlin Bindings
        run: |
          set -euxo pipefail
          mkdir -p artifacts/kotlin

          # Generate Kotlin bindings using uniffi-bindgen
          ./target/release/uniffi-bindgen generate \
            --library target/release/libedgefirst_client.so \
            --language kotlin \
            --out-dir artifacts/kotlin

          # Verify output was generated
          echo "=== Generated Kotlin files ==="
          find artifacts/kotlin -name "*.kt" -type f

          # Check if any Kotlin files exist
          if ! find artifacts/kotlin -name "*.kt" -type f | grep -q .; then
            echo "ERROR: No Kotlin files were generated!"
            exit 1
          fi

      - name: Download Android Libraries
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          pattern: android-*
          path: artifacts/jniLibs/
          merge-multiple: false

      - name: Organize JNI Libraries
        run: |
          set -euxo pipefail

          # Rename directories to match Android JNI conventions
          mkdir -p artifacts/android-sdk/jniLibs
          for abi in arm64-v8a armeabi-v7a x86_64; do
            if [ -d "artifacts/jniLibs/android-${abi}" ]; then
              mkdir -p "artifacts/android-sdk/jniLibs/${abi}"
              cp "artifacts/jniLibs/android-${abi}/libedgefirst_client.so" \
                 "artifacts/android-sdk/jniLibs/${abi}/"
              echo "Copied ${abi} library"
            else
              echo "Warning: android-${abi} not found, skipping"
            fi
          done

          # Verify Kotlin sources exist before copying
          if [ -d "artifacts/kotlin" ] && [ -n "$(ls -A artifacts/kotlin 2>/dev/null)" ]; then
            cp -r artifacts/kotlin/* artifacts/android-sdk/
            echo "Copied Kotlin sources to android-sdk"
          else
            echo "ERROR: artifacts/kotlin is empty or missing"
            exit 1
          fi

      - name: Upload Kotlin SDK
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: edgefirst-client-android
          path: artifacts/android-sdk/
          retention-days: 7

  # ============================================================================
  # Package Swift SDK with XCFramework
  # Downloads Swift bindings from test.yml, packages with release libraries
  # ============================================================================
  generate-swift:
    name: Package Swift SDK
    runs-on: macos-14
    needs: [build-apple]

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Wait for Swift bindings from test.yml
        uses: lewagon/wait-on-check-action@ccfb013c15c8afb7bf2b7c028fb74dc5a068cccc # v1.3.4
        with:
          # For PRs, checks are registered against the head commit, not the merge commit
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
          check-name: 'Generate Swift Bindings'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10

      - name: Download Swift bindings from test.yml
        uses: dawidd6/action-download-artifact@bf251b5aa9c2f7eeb574a96ee720e24f801b7c11 # v6
        with:
          workflow: test.yml
          # For PRs, artifacts are associated with the head commit
          commit: ${{ github.event.pull_request.head.sha || github.sha }}
          name: swift-bindings
          path: artifacts/swift/
          # Allow download even if workflow is still running or failed other jobs
          # We already waited for the specific Generate Swift Bindings job to succeed
          workflow_conclusion: ''

      - name: Verify Swift bindings
        run: |
          echo "=== Downloaded Swift bindings ==="
          ls -la artifacts/swift/
          if ! find artifacts/swift -name "*.swift" -type f | grep -q .; then
            echo "ERROR: No Swift files found in downloaded artifact!"
            exit 1
          fi

      - name: Format Swift Bindings
        run: |
          # Install swift-format (not bundled with Xcode)
          brew install swift-format
          # Format the generated Swift file
          swift-format --in-place artifacts/swift/*.swift
          echo "Swift bindings formatted"

      - name: Download Apple Libraries
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          pattern: apple-*
          path: artifacts/apple-libs/
          merge-multiple: false

      - name: Create iOS Simulator Fat Library
        run: |
          mkdir -p artifacts/apple-libs/ios-sim-fat
          # Combine ARM64 and x86_64 simulator libraries
          lipo -create \
            artifacts/apple-libs/apple-ios-sim-arm64/libedgefirst_client.a \
            artifacts/apple-libs/apple-ios-sim-x86_64/libedgefirst_client.a \
            -output artifacts/apple-libs/ios-sim-fat/libedgefirst_client.a

      - name: Create macOS Fat Library
        run: |
          mkdir -p artifacts/apple-libs/macos-fat
          # Combine ARM64 and x86_64 macOS libraries
          lipo -create \
            artifacts/apple-libs/apple-macos-arm64/libedgefirst_client.a \
            artifacts/apple-libs/apple-macos-x86_64/libedgefirst_client.a \
            -output artifacts/apple-libs/macos-fat/libedgefirst_client.a

      - name: Create XCFramework
        run: |
          mkdir -p artifacts/xcframework

          # List generated Swift artifacts for debugging
          echo "=== Generated Swift artifacts ==="
          find artifacts/swift -type f

          # Create framework directories for each platform
          # Framework name must match internal FFI module name (EdgeFirstClientFFI)
          for platform in ios ios-simulator macos; do
            mkdir -p "artifacts/frameworks/${platform}/EdgeFirstClientFFI.framework/Headers"
            mkdir -p "artifacts/frameworks/${platform}/EdgeFirstClientFFI.framework/Modules"

            # Copy headers
            cp artifacts/swift/EdgeFirstClientFFI.h \
               "artifacts/frameworks/${platform}/EdgeFirstClientFFI.framework/Headers/EdgeFirstClientFFI.h"

            # Copy module map (must be named module.modulemap for XCFramework)
            cp artifacts/swift/EdgeFirstClientFFI.modulemap \
               "artifacts/frameworks/${platform}/EdgeFirstClientFFI.framework/Modules/module.modulemap"
          done

          # Copy static libraries
          cp artifacts/apple-libs/apple-ios/libedgefirst_client.a \
             artifacts/frameworks/ios/EdgeFirstClientFFI.framework/EdgeFirstClientFFI

          cp artifacts/apple-libs/ios-sim-fat/libedgefirst_client.a \
             artifacts/frameworks/ios-simulator/EdgeFirstClientFFI.framework/EdgeFirstClientFFI

          cp artifacts/apple-libs/macos-fat/libedgefirst_client.a \
             artifacts/frameworks/macos/EdgeFirstClientFFI.framework/EdgeFirstClientFFI

          # Create XCFramework
          xcodebuild -create-xcframework \
            -framework artifacts/frameworks/ios/EdgeFirstClientFFI.framework \
            -framework artifacts/frameworks/ios-simulator/EdgeFirstClientFFI.framework \
            -framework artifacts/frameworks/macos/EdgeFirstClientFFI.framework \
            -output artifacts/xcframework/EdgeFirstClient.xcframework

      - name: Package Swift SDK
        run: |
          mkdir -p artifacts/swift-sdk/swift

          # Copy XCFramework at root level
          cp -r artifacts/xcframework/EdgeFirstClient.xcframework artifacts/swift-sdk/

          # Copy Swift bindings to swift/ directory
          cp artifacts/swift/EdgeFirstClient.swift artifacts/swift-sdk/swift/EdgeFirstClient.swift

          # Copy LICENSE
          cp LICENSE artifacts/swift-sdk/

      - name: Upload Swift SDK
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: edgefirst-client-swift
          path: artifacts/swift-sdk/
          retention-days: 7

  # ============================================================================
  # Test Swift SDK (macOS)
  # ============================================================================
  test-swift:
    name: Test Swift SDK
    runs-on: macos-14
    needs: [generate-swift]
    # Only run tests on push to main (not on PRs) to avoid credential exposure
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Download Swift SDK
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: edgefirst-client-swift
          path: swift-sdk/

      - name: Setup Swift SDK for Testing
        run: |
          # Copy XCFramework to expected location
          cp -r swift-sdk/EdgeFirstClient.xcframework .

          # Copy generated Swift bindings (tests are already in repo)
          cp swift-sdk/swift/EdgeFirstClient.swift swift/EdgeFirstClient.swift

          echo "=== Swift SDK files ==="
          ls -la EdgeFirstClient.xcframework/
          ls -la swift/

      - name: Build Swift Package
        env:
          USE_LOCAL_FRAMEWORK: "true"
        run: swift build

      - name: Run Swift Tests
        env:
          USE_LOCAL_FRAMEWORK: "true"
          STUDIO_SERVER: test
          STUDIO_USERNAME: ${{ secrets.STUDIO_USERNAME }}
          STUDIO_PASSWORD: ${{ secrets.STUDIO_PASSWORD }}
        run: |
          swift test --parallel 2>&1 | tee swift-test-output.txt
          echo "Swift tests completed"

      - name: Upload Release Validation Results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: swift-sdk-release-validation
          path: swift-test-output.txt
          retention-days: 7

