# Release Workflow
#
# This workflow orchestrates the release process by:
# 1. Creating the GitHub release
# 2. Downloading pre-built artifacts from build.yml, mobile.yml, and sbom.yml
# 3. Uploading artifacts to the GitHub release
# 4. Publishing to PyPI and crates.io
#
# NOTE: This workflow does NOT rebuild artifacts. It downloads them from the
# workflows that ran when the commit was pushed to main. This saves CI time
# and ensures release artifacts are identical to what was tested.

name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
      - 'v[0-9]+.[0-9]+.[0-9]+rc[0-9]+'

env:
  CARGO_TERM_COLOR: always
  # Pinned Rust version for CI/CD - update manually to control Rust upgrades
  # This ensures consistent builds and allows testing before upgrading
  RUST_STABLE_VERSION: "1.90"

jobs:
  # ==========================================================================
  # Create GitHub Release
  # ==========================================================================
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Get version from tag
        id: get_version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Verify version matches tag
        run: |
          CARGO_VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          TAG_VERSION="${{ steps.get_version.outputs.version }}"
          if [ "$CARGO_VERSION" != "$TAG_VERSION" ]; then
            echo "Error: Cargo.toml version ($CARGO_VERSION) does not match tag version ($TAG_VERSION)"
            exit 1
          fi
          echo "Version verified: $CARGO_VERSION"

      - name: Create Release
        uses: softprops/action-gh-release@6da8fa9354ddfdc4aeace5fc48d7f679b5214090 # v2.4.1
        with:
          name: Release ${{ steps.get_version.outputs.version }}
          draft: false
          prerelease: false
          body: |
            ## What's Changed

            See [CHANGELOG.md](https://github.com/EdgeFirstAI/client/blob/v${{ steps.get_version.outputs.version }}/CHANGELOG.md) for details.

            ## Installation

            ### CLI Binary
            Download the appropriate binary for your platform from the assets below.

            _Alternatively, the pip package includes the CLI (see below)._

            ### Python Package
            ```bash
            pip install edgefirst-client==${{ steps.get_version.outputs.version }}
            ```

            ### Rust Crate
            ```toml
            [dependencies]
            edgefirst-client = "${{ steps.get_version.outputs.version }}"
            ```

            ### Android SDK
            Download `edgefirst-client-android-${{ steps.get_version.outputs.version }}.zip` from the assets below.
            See the included README.md for integration instructions.

            ### iOS/macOS SDK (Swift)

            **Swift Package Manager (Recommended)**
            ```swift
            // In Xcode: File > Add Package Dependencies...
            // Enter: https://github.com/EdgeFirstAI/client.git
            // Select version: ${{ steps.get_version.outputs.version }}
            ```

            **Manual Installation**
            Download `edgefirst-client-swift-${{ steps.get_version.outputs.version }}.zip` from the assets below.
            See the included README.md for integration instructions.

  # ==========================================================================
  # Wait for CI Workflows to Complete
  # ==========================================================================
  wait-for-ci:
    name: Wait for CI Workflows
    needs: [create-release]
    runs-on: ubuntu-latest
    steps:
      - name: Wait for Build workflow
        uses: lewagon/wait-on-check-action@ccfb013c15c8afb7bf2b7c028fb74dc5a068cccc # v1.3.4
        with:
          ref: ${{ github.sha }}
          check-name: 'Verify Builds'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10

      - name: Wait for Mobile SDK workflow
        uses: lewagon/wait-on-check-action@ccfb013c15c8afb7bf2b7c028fb74dc5a068cccc # v1.3.4
        with:
          ref: ${{ github.sha }}
          check-name: 'Generate Swift Bindings'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10

      - name: Wait for SBOM workflow
        uses: lewagon/wait-on-check-action@ccfb013c15c8afb7bf2b7c028fb74dc5a068cccc # v1.3.4
        with:
          ref: ${{ github.sha }}
          check-name: 'Generate SBOM & Check License Compliance'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10

  # ==========================================================================
  # Download and Upload SBOM
  # ==========================================================================
  upload-sbom:
    name: Upload SBOM
    needs: [create-release, wait-for-ci]
    runs-on: ubuntu-latest
    steps:
      - name: Download SBOM artifact
        uses: dawidd6/action-download-artifact@bf251b5aa9c2f7eeb574a96ee720e24f801b7c11 # v6
        with:
          workflow: sbom.yml
          commit: ${{ github.sha }}
          name: sbom
          path: .

      - name: Verify SBOM exists
        run: |
          if [ ! -f sbom.json ]; then
            echo "Error: sbom.json not found in artifacts"
            exit 1
          fi
          echo "SBOM downloaded successfully:"
          ls -la sbom.json

      - name: Upload sbom.json to release
        uses: softprops/action-gh-release@6da8fa9354ddfdc4aeace5fc48d7f679b5214090 # v2.4.1
        with:
          tag_name: v${{ needs.create-release.outputs.version }}
          files: sbom.json

  # ==========================================================================
  # Generate and Upload Man Page
  # ==========================================================================
  generate-manpage:
    name: Generate Man Page
    needs: [create-release]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Install pandoc
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc

      - name: Generate man page
        run: |
          pandoc CLI.md --standalone --to man --output edgefirst-client.1

      - name: Upload man page to release
        uses: softprops/action-gh-release@6da8fa9354ddfdc4aeace5fc48d7f679b5214090 # v2.4.1
        with:
          tag_name: v${{ needs.create-release.outputs.version }}
          files: edgefirst-client.1

  # ==========================================================================
  # Download and Upload CLI Binaries
  # ==========================================================================
  upload-cli:
    name: Upload CLI Binaries
    needs: [create-release, wait-for-ci]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - artifact: edgefirst-client-linux-amd64
            extension: tar.gz
          - artifact: edgefirst-client-linux-arm64
            extension: tar.gz
          - artifact: edgefirst-client-macos-amd64
            extension: tar.gz
          - artifact: edgefirst-client-macos-arm64
            extension: tar.gz
          - artifact: edgefirst-client-windows-amd64.exe
            extension: zip
    steps:
      - name: Download CLI artifact
        uses: dawidd6/action-download-artifact@bf251b5aa9c2f7eeb574a96ee720e24f801b7c11 # v6
        with:
          workflow: build.yml
          commit: ${{ github.sha }}
          name: ${{ matrix.artifact }}
          path: cli/

      - name: Package CLI binary
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"
          cd cli
          if [ "${{ matrix.extension }}" = "zip" ]; then
            zip "../${{ matrix.artifact }}-${VERSION}.zip" *
          else
            tar czf "../${{ matrix.artifact }}-${VERSION}.tar.gz" *
          fi

      - name: Upload CLI to release
        uses: softprops/action-gh-release@6da8fa9354ddfdc4aeace5fc48d7f679b5214090 # v2.4.1
        with:
          tag_name: v${{ needs.create-release.outputs.version }}
          files: ${{ matrix.artifact }}-${{ needs.create-release.outputs.version }}.${{ matrix.extension }}

  # ==========================================================================
  # Download and Upload Python Wheels
  # ==========================================================================
  upload-wheels:
    name: Upload Wheels
    needs: [create-release, wait-for-ci]
    runs-on: ubuntu-latest
    steps:
      - name: Download all wheel artifacts
        uses: dawidd6/action-download-artifact@bf251b5aa9c2f7eeb574a96ee720e24f801b7c11 # v6
        with:
          workflow: build.yml
          commit: ${{ github.sha }}
          name: wheels-*
          name_is_regexp: true
          path: wheels/
          merge_multiple: true

      - name: List downloaded wheels
        run: |
          echo "Downloaded wheels:"
          find wheels -name "*.whl" -type f
          ls -lh wheels/

      - name: Upload wheels to release
        uses: softprops/action-gh-release@6da8fa9354ddfdc4aeace5fc48d7f679b5214090 # v2.4.1
        with:
          tag_name: v${{ needs.create-release.outputs.version }}
          files: wheels/**/*.whl

  # ==========================================================================
  # Download and Upload Mobile SDKs
  # ==========================================================================
  upload-mobile:
    name: Upload Mobile SDKs
    needs: [create-release, wait-for-ci]
    runs-on: macos-14  # Use macOS for swift package compute-checksum
    outputs:
      xcframework_checksum: ${{ steps.checksum.outputs.checksum }}
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Download Android SDK artifact
        uses: dawidd6/action-download-artifact@bf251b5aa9c2f7eeb574a96ee720e24f801b7c11 # v6
        with:
          workflow: mobile.yml
          commit: ${{ github.sha }}
          name: edgefirst-client-android
          path: android-sdk/

      - name: Download Swift SDK artifact
        uses: dawidd6/action-download-artifact@bf251b5aa9c2f7eeb574a96ee720e24f801b7c11 # v6
        with:
          workflow: mobile.yml
          commit: ${{ github.sha }}
          name: edgefirst-client-swift
          path: swift-sdk/

      - name: Package Mobile SDKs
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"

          # Package Android SDK with README
          cp ANDROID.md android-sdk/README.md
          cd android-sdk
          zip -r "../edgefirst-client-android-${VERSION}.zip" .
          cd ..

          # Package Swift SDK for manual download (includes local Package.swift)
          cp APPLE.md swift-sdk/README.md
          cd swift-sdk
          zip -r "../edgefirst-client-swift-${VERSION}.zip" .
          cd ..

          # Create XCFramework ZIP for SPM binary distribution
          # Structure: XCFramework must be at root level of the archive
          # SPM will download this and extract the XCFramework for linking
          cd swift-sdk
          zip -r -X "../EdgeFirstClient-${VERSION}.xcframework.zip" EdgeFirstClient.xcframework
          cd ..

      - name: Compute SPM checksum
        id: checksum
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"
          CHECKSUM=$(swift package compute-checksum "EdgeFirstClient-${VERSION}.xcframework.zip")
          echo "checksum=${CHECKSUM}" >> $GITHUB_OUTPUT
          echo "XCFramework checksum: ${CHECKSUM}"

      - name: Upload Mobile SDKs to release
        uses: softprops/action-gh-release@6da8fa9354ddfdc4aeace5fc48d7f679b5214090 # v2.4.1
        with:
          tag_name: v${{ needs.create-release.outputs.version }}
          files: |
            edgefirst-client-android-${{ needs.create-release.outputs.version }}.zip
            edgefirst-client-swift-${{ needs.create-release.outputs.version }}.zip
            EdgeFirstClient-${{ needs.create-release.outputs.version }}.xcframework.zip

  # ==========================================================================
  # Update Swift Package Manifest
  # ==========================================================================
  update-swift-package:
    name: Update Swift Package
    needs: [create-release, upload-mobile]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          ref: main

      - name: Download Swift SDK artifact
        uses: dawidd6/action-download-artifact@bf251b5aa9c2f7eeb574a96ee720e24f801b7c11 # v6
        with:
          workflow: mobile.yml
          commit: ${{ github.sha }}
          name: edgefirst-client-swift
          path: swift-sdk-temp/

      - name: Update Package.swift with version and checksum
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"
          CHECKSUM="${{ needs.upload-mobile.outputs.xcframework_checksum }}"

          # Update version and checksum variables at top of Package.swift
          sed -i "s|let version = \".*\"|let version = \"${VERSION}\"|" Package.swift
          sed -i "s|let checksum = \".*\"|let checksum = \"${CHECKSUM}\"|" Package.swift

          echo "Updated Package.swift:"
          cat Package.swift

      - name: Update Swift bindings source
        run: |
          # Copy the generated Swift bindings to the repo
          # The swift/ directory is managed by this workflow - do not edit manually
          cp swift-sdk-temp/swift/EdgeFirstClient.swift swift/EdgeFirstClient.swift

          echo "Updated Swift bindings:"
          head -50 swift/EdgeFirstClient.swift

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@5e914681df9dc83aa4e4905692ca88beb2f9e91f # v7.0.5
        with:
          # Requires "Allow GitHub Actions to create and approve pull requests" enabled in repo settings
          commit-message: "automation: update Swift package for v${{ needs.create-release.outputs.version }} release [skip ci]"
          branch: release/update-swift-${{ needs.create-release.outputs.version }}
          delete-branch: true
          title: "automation: Update Swift Package for v${{ needs.create-release.outputs.version }}"
          body: |
            Automated update of Swift Package Manager manifest and bindings for release v${{ needs.create-release.outputs.version }}.

            This PR updates:
            - `Package.swift` with the new version and XCFramework checksum
            - `swift/EdgeFirstClient.swift` with the latest generated bindings

            **XCFramework checksum:** `${{ needs.upload-mobile.outputs.xcframework_checksum }}`

            Created automatically by the release workflow.
          labels: |
            automated
            release
          assignees: ${{ github.actor }}
          signoff: true

  # ==========================================================================
  # Publish to PyPI
  # ==========================================================================
  publish-pypi:
    name: Publish to PyPI
    needs: [create-release, wait-for-ci]
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      id-token: write
    steps:
      - name: Download all wheel artifacts
        uses: dawidd6/action-download-artifact@bf251b5aa9c2f7eeb574a96ee720e24f801b7c11 # v6
        with:
          workflow: build.yml
          commit: ${{ github.sha }}
          name: wheels-*
          name_is_regexp: true
          path: wheels/
          merge_multiple: true

      - name: Flatten wheel directory structure
        run: |
          # Move all .whl files to the root wheels/ directory
          find wheels -name "*.whl" -type f -exec mv {} wheels/ \;
          # Remove now-empty subdirectories
          find wheels -mindepth 1 -type d -delete
          echo "Wheels to publish:"
          ls -lh wheels/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e # v1.13.0
        with:
          packages-dir: wheels/
          skip-existing: true

  # ==========================================================================
  # Publish to crates.io
  # ==========================================================================
  publish-crates-io:
    name: Publish to crates.io
    needs: [create-release]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9 # v1
        with:
          toolchain: ${{ env.RUST_STABLE_VERSION }}

      - name: Verify version matches tag
        run: |
          CARGO_VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          TAG_VERSION="${{ needs.create-release.outputs.version }}"
          if [ "$CARGO_VERSION" != "$TAG_VERSION" ]; then
            echo "Error: Cargo.toml version ($CARGO_VERSION) does not match tag version ($TAG_VERSION)"
            exit 1
          fi
          echo "Version verified: $CARGO_VERSION"

      - name: Publish workspace to crates.io
        run: cargo publish --workspace
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
